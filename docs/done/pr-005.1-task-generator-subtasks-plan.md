# PR-005.1 — Task Generator: Targeted Subtasks (Draft Battle Plan)

## References
- Parent: PR-005 minimal — `docs/dev-plans/pr-005-task-generator-minimal-plan.md`
- OPS Spec: `docs/dev-plans/operational-mcp-integration-spec.md`

## Summary
Enable generating subtasks for an existing task, with local deduplication against existing subtasks. Backward compatible with the minimal generator.

## Scope
- Extend request DTO to target a specific parent task
- Load parent task + existing subtasks as context
- Guardrails in prompt: "propose only missing subtasks"
- Local deduplication by normalized title
- Keep response shape unchanged

Out of scope (Phase 2+): estimates, dependencies, hierarchy persistence, linking.

## API / DTO Changes
```ts
export type GenerationTarget = 'project' | 'task';
export type DedupeStrategy = 'byTitle' | 'none';

export interface GenerateTasksRequestDto {
  prompt: string;
  projectId?: string;
  locale?: string;
  // NEW
  generationTarget?: GenerationTarget; // default 'project'
  parentTaskId?: string;               // required when generationTarget==='task'
  maxTasks?: number;                    // optional, clamped to ≤ 12
  dedupeStrategy?: DedupeStrategy;      // default 'byTitle'
}
```

- Response unchanged (`GenerateTasksResponseDto`).

## Controller / Validation
- 400 if `generationTarget==='task'` and `parentTaskId` is missing
- 404 if `parentTaskId` not found (prefer explicit error over degrade)
- Clamp `maxTasks` to [3,12]; default 12

## Context Service
- Add: `getTask(taskId: string)` → task core fields
- Add: `getSubtasks(taskId: string, limit = 20)` → list of direct children (title only for prompt)

## Tool Behavior (`TaskGeneratorTool`)
- If `generationTarget!=='task'`: current behavior (project-scoped)
- If `generationTarget==='task'`:
  1) Load parent + existing subtasks (titles)
  2) Build prompt with parent title and up to N existing subtask titles
  3) Enforce rules in prompt: no repeats, 3–12, JSON only
  4) After parsing, apply local dedupe by normalized title against existing subtasks
  5) Truncate to `maxTasks` if provided

### Dedupe Algorithm
- `normalize(title)`: lowercase → trim → collapse whitespace → strip punctuation
- Drop generated task if normalized title matches any existing subtask normalized title

## Prompt Delta (only when targeting a task)
```md
User context:
Parent task: "<title>"
Existing subtasks (up to 10): ["…", "…", …]

Rules (in addition to base rules):
- Propose only missing subtasks for this parent
- Do not repeat any title from the existing list
- 3–12 items, concise titles (≤ 80 chars), optional description (≤ 240)
```

## Observability
- Trace attribute `generationTarget` = project|task
- Tag `parentTaskId` when present
- Metric label `deduped_count`

## Error Mapping
- 400: missing `parentTaskId` for task mode
- 404: parent task not found
- 502: provider failure / invalid LLM JSON after repair

## Tests
- Tool: task mode happy path (dedupe applied)
- Tool: clamp by `maxTasks`
- Tool: respects project mode unchanged
- Controller: 400 when missing `parentTaskId`
- Controller: 404 when parent not found

## Rollout
- Feature flag not required (backward compatible). Keep minimal as default.
- API docs: add examples for `generationTarget: 'task'`

## Acceptance Criteria
- Project mode unchanged; still returns 3–12 tasks
- Task mode rejects duplicates present in existing subtasks
- Task mode returns 3–12 tasks after dedupe and clamp
- Swagger documents new request fields and examples

## Tasks (Implementation)
- Update DTO + Zod schema
- Extend `ContextService` with `getTask`/`getSubtasks`
- Update `TaskGeneratorTool` prompt + dedupe
- Update `AiController` validation and Swagger
- Add unit tests (tool + controller)
- Update usage docs with curl examples

---

# PR-005.2 — Task Generator: Subtasks + Relations (Draft)

## Goal
Extend generation to produce:
- Top-level tasks (siblings in current scope)
- Nested `subtasks` per task
- Non-hierarchical `links` (relations) between generated tasks/subtasks and optionally existing tasks

## Contract Extensions (Backward Compatible)
```ts
export type LinkType = 'BLOCKS' | 'IS_BLOCKED_BY' | 'FOLLOWS' | 'RELATES_TO' | 'DUPLICATES';
export type GenerationTarget = 'project' | 'task' | 'selection';

export interface GenerateTasksRequestDto {
  prompt: string;
  projectId?: string;
  locale?: string;
  generationTarget?: GenerationTarget;      // default 'project'
  parentTaskId?: string;                     // required when generationTarget==='task'
  candidateTaskIds?: ReadonlyArray<string>;  // existing tasks to consider for links
  allowedLinkTypes?: ReadonlyArray<LinkType>;// default safe set
  maxTasks?: number;                         // clamp ≤ 12
  maxChildren?: number;                      // clamp ≤ 8 per task
  linkSuggestionMode?: 'none' | 'light' | 'full'; // default 'light'
  dedupeStrategy?: 'byTitle' | 'none';       // default 'byTitle'
}

export interface GeneratedSubtaskDto {
  title: string;
  description?: string;
  priority?: 'LOW' | 'MEDIUM' | 'HIGH';
}

export interface GeneratedTaskDto {
  title: string;
  description?: string;
  priority?: 'LOW' | 'MEDIUM' | 'HIGH';
  subtasks?: ReadonlyArray<GeneratedSubtaskDto>; // NEW optional
}

export interface LinkSuggestionDto {
  sourceTitle: string;                       // generated task/subtask title
  targetTitle?: string;                      // generated task/subtask title
  targetTaskId?: string;                     // existing task (must be in candidateTaskIds)
  type: LinkType;
}

export interface GenerateTasksResponseDto {
  tasks: ReadonlyArray<GeneratedTaskDto>;    // unchanged (3..12)
  links?: ReadonlyArray<LinkSuggestionDto>;  // NEW optional
  meta: { model: string; provider: string; degraded: boolean };
}
```

## Behavior
- Project target: generate tasks; include up to `maxChildren` subtasks each; suggest up to K links based on `linkSuggestionMode`.
- Task target: generate only subtasks for `parentTaskId`; return as `tasks: [{ title: '<parent:readonly>', subtasks: [...] }]` or keep `tasks: []` and surface via a dedicated field (prefer first for simplicity).
- Selection target: consider `candidateTaskIds` as eligible link targets; generate tasks and light link suggestions to those.

## Prompt Delta
- Include minimal schema with nested `subtasks` and a `links` array.
- Guardrails:
  - JSON only; no IDs invented.
  - Use `targetTaskId` only when provided in candidate list; otherwise use `targetTitle`.
  - At most K links (light ≤ 2, full ≤ 6). Prefer BLOCKS/FOLLOWS when ordering is implied.
  - Do not repeat any existing subtask titles (when targeting a parent).

## Server-Side Safety
- Normalize titles and dedupe across generated items and existing subtasks.
- Validate links:
  - `sourceTitle`/`targetTitle` must match generated titles; drop otherwise.
  - `targetTaskId` must be in `candidateTaskIds`; drop otherwise.
  - De-dupe links by (source,target,type); treat RELATES_TO as symmetric.
- Clamp counts by config; set `meta.degraded=true` when dropping.

## Context Needs
- `getProject`, `getTasks`
- `getTask`, `getSubtasks`
- (Optional later) `getExistingLinks` for duplicate avoidance

## Tests
- Generates subtasks with clamping; no duplicates vs existing.
- Emits ≤ K links by mode; drops invalid targets; respects allowed types.
- Fuzzy title mapping gated by high threshold if applied.

## Docs & Swagger
- Add examples for nested `subtasks` and `links` in request/response.
- Document review flow: user approves tasks, hierarchy, and link suggestions before persistence.
